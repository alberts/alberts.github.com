<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <title>LCOV - go.info - /home/alberts/deps/src/code.google.com/p/go.crypto/ssh/agent.go</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../../../index.html">top level</a> - <a href="index.html">home/alberts/deps/src/code.google.com/p/go.crypto/ssh</a> - agent.go<span style="font-size: 80%;"> (source / <a href="agent.go.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">go.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">99</td>
            <td class="headerCovTableEntryLo">1.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2012-03-12</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">3</td>
            <td class="headerCovTableEntry">26</td>
            <td class="headerCovTableEntryLo">11.5 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">3</td>
            <td class="headerCovTableEntry">237</td>
            <td class="headerCovTableEntryLo">1.3 %</td>
          </tr>
          <tr><td><img src="../../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : // Copyright 2012 The Go Authors. All rights reserved.</a>
<span class="lineNum">       2 </span>                :            : // Use of this source code is governed by a BSD-style
<span class="lineNum">       3 </span>                :            : // license that can be found in the LICENSE file.
<span class="lineNum">       4 </span>                :            : 
<span class="lineNum">       5 </span>                :            : package ssh
<span class="lineNum">       6 </span>                :            : 
<span class="lineNum">       7 </span>                :            : // References
<span class="lineNum">       8 </span>                :            : //   PROTOCOL.agent: http://www.openbsd.org/cgi-bin/cvsweb/src/usr.bin/ssh/PROTOCOL.agent
<a name="9"><span class="lineNum">       9 </span>                :            : </a>
<span class="lineNum">      10 </span>                :            : import (
<span class="lineNum">      11 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">        931 :         &quot;encoding/base64&quot;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 8 was taken 180 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>][<span class="branchCov" title="Branch 10 was taken 180 times"> + </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 12 was not executed"> # </span><span class="branchNoExec" title="Branch 13 was not executed"> # </span>][<span class="branchCov" title="Branch 14 was taken 571 times"> + </span><span class="branchNoCov" title="Branch 15 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>][<span class="branchNoExec" title="Branch 18 was not executed"> # </span><span class="branchNoExec" title="Branch 19 was not executed"> # </span>]
<a name="12"><span class="lineNum">      12 </span>                :            :         &quot;errors&quot;</a>
<span class="lineNum">      13 </span>                :            :         &quot;fmt&quot;
<span class="lineNum">      14 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         &quot;io&quot;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 9 was not executed"> # </span><span class="branchNoExec" title="Branch 10 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 12 was not executed"> # </span><span class="branchNoExec" title="Branch 13 was not executed"> # </span>][<span class="branchNoExec" title="Branch 15 was not executed"> # </span><span class="branchNoExec" title="Branch 16 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 18 was not executed"> # </span><span class="branchNoExec" title="Branch 19 was not executed"> # </span>][<span class="branchNoExec" title="Branch 21 was not executed"> # </span><span class="branchNoExec" title="Branch 22 was not executed"> # </span>]
<span class="lineNum">      15 </span>                :            : )
<span class="lineNum">      16 </span>                :            : 
<span class="lineNum">      17 </span>                :            : // See PROTOCOL.agent, section 3.
<span class="lineNum">      18 </span>                :            : const (
<span class="lineNum">      19 </span>                :            :         // 3.2 Requests from client to agent for protocol 2 key operations
<span class="lineNum">      20 </span>                :            :         agentRequestIdentities   = 11
<span class="lineNum">      21 </span>                :            :         agentSignRequest         = 13
<span class="lineNum">      22 </span>                :            :         agentAddIdentity         = 17
<span class="lineNum">      23 </span>                :            :         agentRemoveIdentity      = 18
<span class="lineNum">      24 </span>                :            :         agentRemoveAllIdentities = 19
<span class="lineNum">      25 </span>                :            :         agentAddIdConstrained    = 25
<span class="lineNum">      26 </span>                :            : 
<span class="lineNum">      27 </span>                :            :         // 3.3 Key-type independent requests from client to agent
<span class="lineNum">      28 </span>                :            :         agentAddSmartcardKey            = 20
<span class="lineNum">      29 </span>                :            :         agentRemoveSmartcardKey         = 21
<span class="lineNum">      30 </span>                :            :         agentLock                       = 22
<span class="lineNum">      31 </span>                :            :         agentUnlock                     = 23
<span class="lineNum">      32 </span>                :            :         agentAddSmartcardKeyConstrained = 26
<span class="lineNum">      33 </span>                :            : 
<span class="lineNum">      34 </span>                :            :         // 3.4 Generic replies from agent to client
<span class="lineNum">      35 </span>                :            :         agentFailure = 5
<span class="lineNum">      36 </span>                :            :         agentSuccess = 6
<span class="lineNum">      37 </span>                :            : 
<span class="lineNum">      38 </span>                :            :         // 3.6 Replies from agent to client for protocol 2 key operations
<span class="lineNum">      39 </span>                :            :         agentIdentitiesAnswer = 12
<span class="lineNum">      40 </span>                :            :         agentSignResponse     = 14
<span class="lineNum">      41 </span>                :            : 
<span class="lineNum">      42 </span>                :            :         // 3.7 Key constraint identifiers
<span class="lineNum">      43 </span>                :            :         agentConstrainLifetime = 1
<span class="lineNum">      44 </span>                :            :         agentConstrainConfirm  = 2
<span class="lineNum">      45 </span>                :            : )
<span class="lineNum">      46 </span>                :            : 
<span class="lineNum">      47 </span>                :            : // Agent messages:
<span class="lineNum">      48 </span>                :            : // These structures mirror the wire format of the corresponding ssh agent
<span class="lineNum">      49 </span>                :            : // messages found in PROTOCOL.agent.
<span class="lineNum">      50 </span>                :            : 
<span class="lineNum">      51 </span>                :            : type failureAgentMsg struct{}
<span class="lineNum">      52 </span>                :            : 
<span class="lineNum">      53 </span>                :            : type successAgentMsg struct{}
<span class="lineNum">      54 </span>                :            : 
<span class="lineNum">      55 </span>                :            : // See PROTOCOL.agent, section 2.5.2.
<span class="lineNum">      56 </span>                :            : type requestIdentitiesAgentMsg struct{}
<span class="lineNum">      57 </span>                :            : 
<span class="lineNum">      58 </span>                :            : // See PROTOCOL.agent, section 2.5.2.
<span class="lineNum">      59 </span>                :            : type identitiesAnswerAgentMsg struct {
<span class="lineNum">      60 </span>                :            :         NumKeys uint32
<span class="lineNum">      61 </span>                :            :         Keys    []byte `ssh:&quot;rest&quot;`
<span class="lineNum">      62 </span>                :            : }
<span class="lineNum">      63 </span>                :            : 
<span class="lineNum">      64 </span>                :            : // See PROTOCOL.agent, section 2.6.2.
<span class="lineNum">      65 </span>                :            : type signRequestAgentMsg struct {
<span class="lineNum">      66 </span>                :            :         KeyBlob []byte
<span class="lineNum">      67 </span>                :            :         Data    []byte
<span class="lineNum">      68 </span>                :            :         Flags   uint32
<span class="lineNum">      69 </span>                :            : }
<span class="lineNum">      70 </span>                :            : 
<span class="lineNum">      71 </span>                :            : // See PROTOCOL.agent, section 2.6.2.
<span class="lineNum">      72 </span>                :            : type signResponseAgentMsg struct {
<span class="lineNum">      73 </span>                :            :         SigBlob []byte
<span class="lineNum">      74 </span>                :            : }
<span class="lineNum">      75 </span>                :            : 
<span class="lineNum">      76 </span>                :            : // AgentKey represents a protocol 2 key as defined in PROTOCOL.agent,
<span class="lineNum">      77 </span>                :            : // section 2.5.2.
<span class="lineNum">      78 </span>                :            : type AgentKey struct {
<span class="lineNum">      79 </span>                :            :         blob    []byte
<span class="lineNum">      80 </span>                :            :         Comment string
<span class="lineNum">      81 </span>                :            : }
<span class="lineNum">      82 </span>                :            : 
<a name="83"><span class="lineNum">      83 </span>                :            : // String returns the storage form of an agent key with the format, base64</a>
<span class="lineNum">      84 </span>                :            : // encoded serialized key, and the comment if it is not empty.
<span class="lineNum">      85 </span>                :<span class="lineNoCov">          0 : func (ak *AgentKey) String() string {</span>
<span class="lineNum">      86 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         algo, _, ok := parseString(ak.blob)</span>
<span class="lineNum">      87 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if !ok {</span>
<span class="lineNum">      88 </span>                :<span class="lineNoCov">          0 :                 return &quot;malformed key&quot;</span>
<span class="lineNum">      89 </span>                :            :         }
<span class="lineNum">      90 </span>                :            : 
<span class="lineNum">      91 </span>                :<span class="lineNoCov">          0 :         algoName := string(algo)</span>
<span class="lineNum">      92 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         b64EncKey := base64.StdEncoding.EncodeToString(ak.blob)</span>
<span class="lineNum">      93 </span>                :<span class="lineNoCov">          0 :         comment := &quot;&quot;</span>
<span class="lineNum">      94 </span>                :            : 
<span class="lineNum">      95 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ak.Comment != &quot;&quot; {</span>
<span class="lineNum">      96 </span>                :<span class="lineNoCov">          0 :                 comment = &quot; &quot; + ak.Comment</span>
<span class="lineNum">      97 </span>                :            :         }
<span class="lineNum">      98 </span>                :            : 
<span class="lineNum">      99 </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return fmt.Sprintf(&quot;%s %s%s&quot;, algoName, b64EncKey, comment)</span>
<span class="lineNum">     100 </span>                :            : }
<span class="lineNum">     101 </span>                :            : 
<a name="102"><span class="lineNum">     102 </span>                :            : // Key returns an agent's public key as a *rsa.PublicKey, *dsa.PublicKey, or</a>
<span class="lineNum">     103 </span>                :            : // *OpenSSHCertV01.
<span class="lineNum">     104 </span>                :<span class="lineNoCov">          0 : func (ak *AgentKey) Key() (interface{}, error) {</span>
<span class="lineNum">     105 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if key, _, ok := parsePubKey(ak.blob); ok {</span>
<span class="lineNum">     106 </span>                :<span class="lineNoCov">          0 :                 return key, nil</span>
<span class="lineNum">     107 </span>                :            :         }
<span class="lineNum">     108 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return nil, errors.New(&quot;ssh: failed to parse key blob&quot;)</span>
<a name="109"><span class="lineNum">     109 </span>                :            : }</a>
<span class="lineNum">     110 </span>                :            : 
<span class="lineNum">     111 </span>                :<span class="lineNoCov">          0 : func parseAgentKey(in []byte) (out *AgentKey, rest []byte, ok bool) {</span>
<span class="lineNum">     112 </span>                :<span class="lineNoCov">          0 :         ak := new(AgentKey)</span>
<span class="lineNum">     113 </span>                :            : 
<span class="lineNum">     114 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ak.blob, in, ok = parseString(in); !ok {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">     115 </span>                :<span class="lineNoCov">          0 :                 return</span>
<span class="lineNum">     116 </span>                :            :         }
<span class="lineNum">     117 </span>                :            : 
<span class="lineNum">     118 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         comment, in, ok := parseString(in)</span>
<span class="lineNum">     119 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if !ok {</span>
<span class="lineNum">     120 </span>                :<span class="lineNoCov">          0 :                 return</span>
<span class="lineNum">     121 </span>                :            :         }
<span class="lineNum">     122 </span>                :<span class="lineNoCov">          0 :         ak.Comment = string(comment)</span>
<span class="lineNum">     123 </span>                :            : 
<span class="lineNum">     124 </span>                :<span class="lineNoCov">          0 :         return ak, in, true</span>
<span class="lineNum">     125 </span>                :            : }
<span class="lineNum">     126 </span>                :            : 
<span class="lineNum">     127 </span>                :            : // AgentClient provides a means to communicate with an ssh agent process based
<span class="lineNum">     128 </span>                :            : // on the protocol described in PROTOCOL.agent?rev=1.6.  It contains an
<span class="lineNum">     129 </span>                :            : // embedded io.ReadWriter that is typically represented by using a *net.UnixConn.
<span class="lineNum">     130 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 : type AgentClient struct {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     131 </span>                :            :         io.ReadWriter
<a name="132"><span class="lineNum">     132 </span>                :            : }</a>
<span class="lineNum">     133 </span>                :            : 
<span class="lineNum">     134 </span>                :<span class="lineNoCov">          0 : func (ac *AgentClient) sendRequest(req []byte) error {</span>
<span class="lineNum">     135 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         msg := make([]byte, stringLength(req))</span>
<span class="lineNum">     136 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         marshalString(msg, req)</span>
<span class="lineNum">     137 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if _, err := ac.Write(msg); err != nil {</span>
<span class="lineNum">     138 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return err</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">     139 </span>                :            :         }
<span class="lineNum">     140 </span>                :<span class="lineNoCov">          0 :         return nil</span>
<a name="141"><span class="lineNum">     141 </span>                :            : }</a>
<span class="lineNum">     142 </span>                :            : 
<span class="lineNum">     143 </span>                :<span class="lineNoCov">          0 : func (ac *AgentClient) readResponse() ([]byte, error) {</span>
<span class="lineNum">     144 </span>                :<span class="lineNoCov">          0 :         var respSizeBuf [4]byte</span>
<span class="lineNum">     145 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if _, err := io.ReadFull(ac, respSizeBuf[:]); err != nil {</span>
<span class="lineNum">     146 </span>                :<span class="lineNoCov">          0 :                 return nil, err</span>
<span class="lineNum">     147 </span>                :            :         }
<span class="lineNum">     148 </span>                :            : 
<span class="lineNum">     149 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         respSize, _, ok := parseUint32(respSizeBuf[:])</span>
<span class="lineNum">     150 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if !ok {</span>
<span class="lineNum">     151 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return nil, errors.New(&quot;ssh: failure to parse response size&quot;)</span>
<span class="lineNum">     152 </span>                :            :         }
<span class="lineNum">     153 </span>                :            : 
<span class="lineNum">     154 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         buf := make([]byte, respSize)</span>
<span class="lineNum">     155 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if _, err := io.ReadFull(ac, buf); err != nil {</span>
<span class="lineNum">     156 </span>                :<span class="lineNoCov">          0 :                 return nil, err</span>
<span class="lineNum">     157 </span>                :            :         }
<span class="lineNum">     158 </span>                :<span class="lineNoCov">          0 :         return buf, nil</span>
<span class="lineNum">     159 </span>                :            : }
<span class="lineNum">     160 </span>                :            : 
<a name="161"><span class="lineNum">     161 </span>                :            : // RequestIdentities queries the agent for protocol 2 keys as defined in</a>
<span class="lineNum">     162 </span>                :            : // PROTOCOL.agent section 2.5.2.
<span class="lineNum">     163 </span>                :<span class="lineNoCov">          0 : func (ac *AgentClient) RequestIdentities() ([]*AgentKey, error) {</span>
<span class="lineNum">     164 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         req := marshal(agentRequestIdentities, requestIdentitiesAgentMsg{})</span>
<span class="lineNum">     165 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if err := ac.sendRequest(req); err != nil {</span>
<span class="lineNum">     166 </span>                :<span class="lineNoCov">          0 :                 return nil, err</span>
<span class="lineNum">     167 </span>                :            :         }
<span class="lineNum">     168 </span>                :            : 
<span class="lineNum">     169 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         resp, err := ac.readResponse()</span>
<span class="lineNum">     170 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if err != nil {</span>
<span class="lineNum">     171 </span>                :<span class="lineNoCov">          0 :                 return nil, err</span>
<span class="lineNum">     172 </span>                :            :         }
<span class="lineNum">     173 </span>                :            : 
<span class="lineNum">     174 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         switch msg := decodeAgentMsg(resp).(type) {</span>
<span class="lineNum">     175 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         case *identitiesAnswerAgentMsg:</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">     176 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 keys := make([]*AgentKey, msg.NumKeys)</span>
<span class="lineNum">     177 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 data := msg.Keys[:]</span>
<span class="lineNum">     178 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 for i := uint32(0); i &lt; msg.NumKeys; i++ {</span>
<span class="lineNum">     179 </span>                :<span class="lineNoCov">          0 :                         var key *AgentKey</span>
<span class="lineNum">     180 </span>                :<span class="lineNoCov">          0 :                         var ok bool</span>
<span class="lineNum">     181 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if key, data, ok = parseAgentKey(data); !ok {</span>
<span class="lineNum">     182 </span>                :<span class="lineNoCov">          0 :                                 return nil, ParseError{agentIdentitiesAnswer}</span>
<span class="lineNum">     183 </span>                :            :                         }
<span class="lineNum">     184 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         keys[i] = key</span>
<span class="lineNum">     185 </span>                :            :                 }
<span class="lineNum">     186 </span>                :<span class="lineNoCov">          0 :                 return keys, nil</span>
<span class="lineNum">     187 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         case *failureAgentMsg:</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">     188 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return nil, errors.New(&quot;ssh: failed to list keys.&quot;)</span>
<span class="lineNum">     189 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         case ParseError, UnexpectedMessageError:</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     190 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return nil, msg.(error)</span>
<span class="lineNum">     191 </span>                :            :         }
<span class="lineNum">     192 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return nil, UnexpectedMessageError{agentIdentitiesAnswer, resp[0]}</span>
<span class="lineNum">     193 </span>                :            : }
<span class="lineNum">     194 </span>                :            : 
<span class="lineNum">     195 </span>                :            : // SignRequest requests the signing of data by the agent using a protocol 2 key
<a name="196"><span class="lineNum">     196 </span>                :            : // as defined in PROTOCOL.agent section 2.6.2.  Supported key types include</a>
<span class="lineNum">     197 </span>                :            : // *rsa.PublicKey, *dsa.PublicKey, *OpenSSHCertV01.
<span class="lineNum">     198 </span>                :<span class="lineNoCov">          0 : func (ac *AgentClient) SignRequest(key interface{}, data []byte) ([]byte, error) {</span>
<span class="lineNum">     199 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         req := marshal(agentSignRequest, signRequestAgentMsg{</span>
<span class="lineNum">     200 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 KeyBlob: serializePublickey(key),</span>
<span class="lineNum">     201 </span>                :            :                 Data:    data,
<span class="lineNum">     202 </span>                :            :         })
<span class="lineNum">     203 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if err := ac.sendRequest(req); err != nil {</span>
<span class="lineNum">     204 </span>                :<span class="lineNoCov">          0 :                 return nil, err</span>
<span class="lineNum">     205 </span>                :            :         }
<span class="lineNum">     206 </span>                :            : 
<span class="lineNum">     207 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         resp, err := ac.readResponse()</span>
<span class="lineNum">     208 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if err != nil {</span>
<span class="lineNum">     209 </span>                :<span class="lineNoCov">          0 :                 return nil, err</span>
<span class="lineNum">     210 </span>                :            :         }
<span class="lineNum">     211 </span>                :            : 
<span class="lineNum">     212 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         switch msg := decodeAgentMsg(resp).(type) {</span>
<span class="lineNum">     213 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         case *signResponseAgentMsg:</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">     214 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return msg.SigBlob, nil</span>
<span class="lineNum">     215 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         case *failureAgentMsg:</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">     216 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return nil, errors.New(&quot;ssh: failed to sign challenge&quot;)</span>
<span class="lineNum">     217 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         case ParseError, UnexpectedMessageError:</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     218 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return nil, msg.(error)</span>
<span class="lineNum">     219 </span>                :            :         }
<span class="lineNum">     220 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return nil, UnexpectedMessageError{agentSignResponse, resp[0]}</span>
<a name="221"><span class="lineNum">     221 </span>                :            : }</a>
<span class="lineNum">     222 </span>                :            : 
<span class="lineNum">     223 </span>                :<span class="lineNoCov">          0 : func decodeAgentMsg(packet []byte) interface{} {</span>
<span class="lineNum">     224 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if len(packet) &lt; 1 {</span>
<span class="lineNum">     225 </span>                :<span class="lineNoCov">          0 :                 return ParseError{0}</span>
<span class="lineNum">     226 </span>                :            :         }
<span class="lineNum">     227 </span>                :<span class="lineNoCov">          0 :         var msg interface{}</span>
<span class="lineNum">     228 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         switch packet[0] {</span>
<span class="lineNum">         </span>  [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">         </span>            <span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     229 </span>                :<span class="lineNoCov">          0 :         case agentFailure:</span>
<span class="lineNum">     230 </span>                :<span class="lineNoCov">          0 :                 msg = new(failureAgentMsg)</span>
<span class="lineNum">     231 </span>                :<span class="lineNoCov">          0 :         case agentSuccess:</span>
<span class="lineNum">     232 </span>                :<span class="lineNoCov">          0 :                 msg = new(successAgentMsg)</span>
<span class="lineNum">     233 </span>                :<span class="lineNoCov">          0 :         case agentIdentitiesAnswer:</span>
<span class="lineNum">     234 </span>                :<span class="lineNoCov">          0 :                 msg = new(identitiesAnswerAgentMsg)</span>
<span class="lineNum">     235 </span>                :<span class="lineNoCov">          0 :         case agentSignResponse:</span>
<span class="lineNum">     236 </span>                :<span class="lineNoCov">          0 :                 msg = new(signResponseAgentMsg)</span>
<span class="lineNum">     237 </span>                :            :         default:
<span class="lineNum">     238 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return UnexpectedMessageError{0, packet[0]}</span>
<span class="lineNum">     239 </span>                :            :         }
<span class="lineNum">     240 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if err := unmarshal(msg, packet, packet[0]); err != nil {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     241 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return err</span>
<span class="lineNum">     242 </span>                :            :         }
<span class="lineNum">     243 </span>                :<span class="lineNoCov">          0 :         return msg</span>
<span class="lineNum">     244 </span>                :            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.9</a></td></tr>
  </table>
  <br>

</body>
</html>
