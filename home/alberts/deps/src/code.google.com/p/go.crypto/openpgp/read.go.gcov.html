<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <title>LCOV - go.info - /home/alberts/deps/src/code.google.com/p/go.crypto/openpgp/read.go</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../../../index.html">top level</a> - <a href="index.html">home/alberts/deps/src/code.google.com/p/go.crypto/openpgp</a> - read.go<span style="font-size: 80%;"> (source / <a href="read.go.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">go.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">142</td>
            <td class="headerCovTableEntry">182</td>
            <td class="headerCovTableEntryMed">78.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2012-03-12</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">7</td>
            <td class="headerCovTableEntry">13</td>
            <td class="headerCovTableEntryLo">53.8 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">251</td>
            <td class="headerCovTableEntry">547</td>
            <td class="headerCovTableEntryLo">45.9 %</td>
          </tr>
          <tr><td><img src="../../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : // Copyright 2011 The Go Authors. All rights reserved.</a>
<span class="lineNum">       2 </span>                :            : // Use of this source code is governed by a BSD-style
<span class="lineNum">       3 </span>                :            : // license that can be found in the LICENSE file.
<span class="lineNum">       4 </span>                :            : 
<span class="lineNum">       5 </span>                :            : // Package openpgp implements high level operations on OpenPGP messages.
<span class="lineNum">       6 </span>                :            : package openpgp
<span class="lineNum">       7 </span>                :            : 
<span class="lineNum">       8 </span>                :            : import (
<span class="lineNum">       9 </span>                :            :         &quot;code.google.com/p/go.crypto/openpgp/armor&quot;
<span class="lineNum">      10 </span>                :            :         &quot;code.google.com/p/go.crypto/openpgp/errors&quot;
<span class="lineNum">      11 </span>                :            :         &quot;code.google.com/p/go.crypto/openpgp/packet&quot;
<span class="lineNum">      12 </span>                :            :         &quot;crypto&quot;
<span class="lineNum">      13 </span>                :            :         _ &quot;crypto/sha256&quot;
<span class="lineNum">      14 </span>                :            :         &quot;hash&quot;
<span class="lineNum">      15 </span>                :            :         &quot;io&quot;
<span class="lineNum">      16 </span>                :            :         &quot;strconv&quot;
<span class="lineNum">      17 </span>                :            : )
<span class="lineNum">      18 </span>                :            : 
<span class="lineNum">      19 </span>                :            : // SignatureType is the armor type for a PGP signature.
<span class="lineNum">      20 </span>                :            : var SignatureType = &quot;PGP SIGNATURE&quot;
<a name="21"><span class="lineNum">      21 </span>                :            : </a>
<span class="lineNum">      22 </span>                :            : // readArmored reads an armored block with the given type.
<span class="lineNum">      23 </span>                :<span class="lineNoCov">          0 : func readArmored(r io.Reader, expectedType string) (body io.Reader, err error) {</span>
<span class="lineNum">      24 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         block, err := armor.Decode(r)</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">      25 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if err != nil {</span>
<span class="lineNum">      26 </span>                :<span class="lineNoCov">          0 :                 return</span>
<span class="lineNum">      27 </span>                :            :         }
<span class="lineNum">      28 </span>                :            : 
<span class="lineNum">      29 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if block.Type != expectedType {</span>
<span class="lineNum">      30 </span>                :<span class="lineNoCov">          0 :                 return nil, errors.InvalidArgumentError(&quot;expected '&quot; + expectedType + &quot;', got: &quot; + block.Type)</span>
<span class="lineNum">      31 </span>                :            :         }
<span class="lineNum">      32 </span>                :            : 
<span class="lineNum">      33 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return block.Body, nil</span>
<span class="lineNum">      34 </span>                :            : }
<span class="lineNum">      35 </span>                :            : 
<span class="lineNum">      36 </span>                :            : // MessageDetails contains the result of parsing an OpenPGP encrypted and/or
<span class="lineNum">      37 </span>                :            : // signed message.
<span class="lineNum">      38 </span>                :            : type MessageDetails struct {
<span class="lineNum">      39 </span>                :            :         IsEncrypted              bool                // true if the message was encrypted.
<span class="lineNum">      40 </span>                :            :         EncryptedToKeyIds        []uint64            // the list of recipient key ids.
<span class="lineNum">      41 </span>                :            :         IsSymmetricallyEncrypted bool                // true if a passphrase could have decrypted the message.
<span class="lineNum">      42 </span>                :            :         DecryptedWith            Key                 // the private key used to decrypt the message, if any.
<span class="lineNum">      43 </span>                :            :         IsSigned                 bool                // true if the message is signed.
<span class="lineNum">      44 </span>                :            :         SignedByKeyId            uint64              // the key id of the signer, if any.
<span class="lineNum">      45 </span>                :            :         SignedBy                 *Key                // the key of the signer, if available.
<span class="lineNum">      46 </span>                :            :         LiteralData              *packet.LiteralData // the metadata of the contents
<span class="lineNum">      47 </span>                :            :         UnverifiedBody           io.Reader           // the contents of the message.
<span class="lineNum">      48 </span>                :            : 
<span class="lineNum">      49 </span>                :            :         // If IsSigned is true and SignedBy is non-zero then the signature will
<span class="lineNum">      50 </span>                :            :         // be verified as UnverifiedBody is read. The signature cannot be
<span class="lineNum">      51 </span>                :            :         // checked until the whole of UnverifiedBody is read so UnverifiedBody
<span class="lineNum">      52 </span>                :            :         // must be consumed until EOF before the data can trusted. Even if a
<span class="lineNum">      53 </span>                :            :         // message isn't signed (or the signer is unknown) the data may contain
<span class="lineNum">      54 </span>                :            :         // an authentication code that is only checked once UnverifiedBody has
<span class="lineNum">      55 </span>                :            :         // been consumed. Once EOF has been seen, the following fields are
<span class="lineNum">      56 </span>                :            :         // valid. (An authentication code failure is reported as a
<span class="lineNum">      57 </span>                :            :         // SignatureError error when reading from UnverifiedBody.)
<span class="lineNum">      58 </span>                :            :         SignatureError error             // nil if the signature is good.
<span class="lineNum">      59 </span>                :            :         Signature      *packet.Signature // the signature packet itself.
<span class="lineNum">      60 </span>                :            : 
<span class="lineNum">      61 </span>                :            :         decrypted io.ReadCloser
<span class="lineNum">      62 </span>                :            : }
<span class="lineNum">      63 </span>                :            : 
<span class="lineNum">      64 </span>                :            : // A PromptFunction is used as a callback by functions that may need to decrypt
<span class="lineNum">      65 </span>                :            : // a private key, or prompt for a passphrase. It is called with a list of
<span class="lineNum">      66 </span>                :            : // acceptable, encrypted private keys and a boolean that indicates whether a
<span class="lineNum">      67 </span>                :            : // passphrase is usable. It should either decrypt a private key or return a
<span class="lineNum">      68 </span>                :            : // passphrase to try. If the decrypted private key or given passphrase isn't
<span class="lineNum">      69 </span>                :            : // correct, the function will be called again, forever. Any error returned will
<span class="lineNum">      70 </span>                :            : // be passed up.
<span class="lineNum">      71 </span>                :            : type PromptFunction func(keys []Key, symmetric bool) ([]byte, error)
<span class="lineNum">      72 </span>                :            : 
<span class="lineNum">      73 </span>                :            : // A keyEnvelopePair is used to store a private key with the envelope that
<span class="lineNum">      74 </span>                :            : // contains a symmetric key, encrypted with that key.
<span class="lineNum">      75 </span>                :            : type keyEnvelopePair struct {
<span class="lineNum">      76 </span>                :            :         key          Key
<span class="lineNum">      77 </span>                :            :         encryptedKey *packet.EncryptedKey
<span class="lineNum">      78 </span>                :            : }
<span class="lineNum">      79 </span>                :            : 
<span class="lineNum">      80 </span>                :            : // ReadMessage parses an OpenPGP message that may be signed and/or encrypted.
<span class="lineNum">      81 </span>                :            : // The given KeyRing should contain both public keys (for signature
<a name="82"><span class="lineNum">      82 </span>                :            : // verification) and, possibly encrypted, private keys for decrypting.</a>
<span class="lineNum">      83 </span>                :            : // If config is nil, sensible defaults will be used.
<span class="lineNum">      84 </span>                :<span class="lineCov">         11 : func ReadMessage(r io.Reader, keyring KeyRing, prompt PromptFunction, config *packet.Config) (md *MessageDetails, err error) {</span>
<span class="lineNum">      85 </span>                :<span class="lineCov">         11 :         var p packet.Packet</span>
<span class="lineNum">      86 </span>                :            : 
<span class="lineNum">      87 </span>                :<span class="lineCov">         11 :         var symKeys []*packet.SymmetricKeyEncrypted</span>
<span class="lineNum">      88 </span>                :<span class="lineCov">         11 :         var pubKeys []keyEnvelopePair</span>
<span class="lineNum">      89 </span>                :<span class="lineCov">         11 :         var se *packet.SymmetricallyEncrypted</span>
<span class="lineNum">      90 </span>                :            : 
<span class="lineNum">      91 </span>        [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         11 :         packets := packet.NewReader(r)</span>
<span class="lineNum">      92 </span>                :<span class="lineCov">         11 :         md = new(MessageDetails)</span>
<span class="lineNum">      93 </span>        [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         11 :         md.IsEncrypted = true</span>
<span class="lineNum">      94 </span>                :            : 
<span class="lineNum">      95 </span>                :            :         // The message, if encrypted, starts with a number of packets
<span class="lineNum">      96 </span>                :            :         // containing an encrypted decryption key. The decryption key is either
<span class="lineNum">      97 </span>                :            :         // encrypted to a public key, or with a passphrase. This loop
<span class="lineNum">      98 </span>                :            :         // collects these packets.
<span class="lineNum">      99 </span>                :            : ParsePackets:
<span class="lineNum">     100 </span>                :            :         for {
<span class="lineNum">     101 </span>        [<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         20 :                 p, err = packets.Next()</span>
<span class="lineNum">     102 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span>]:<span class="lineCov">         20 :                 if err != nil {</span>
<span class="lineNum">     103 </span>                :<span class="lineNoCov">          0 :                         return nil, err</span>
<span class="lineNum">     104 </span>                :            :                 }
<span class="lineNum">     105 </span>        [<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         20 :                 switch p := p.(type) {</span>
<span class="lineNum">     106 </span>[<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 18 times"> + </span><span class="branchCov" title="Branch 4 was taken 2 times"> + </span>]:<span class="lineCov">         20 :                 case *packet.SymmetricKeyEncrypted:</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 5 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>][<span class="branchCov" title="Branch 7 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 9 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span>]
<span class="lineNum">     107 </span>                :            :                         // This packet contains the decryption key encrypted with a passphrase.
<span class="lineNum">     108 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :                         md.IsSymmetricallyEncrypted = true</span>
<span class="lineNum">     109 </span>                :<span class="lineCov">          2 :                         symKeys = append(symKeys, p)</span>
<span class="lineNum">     110 </span>[<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 11 times"> + </span><span class="branchCov" title="Branch 4 was taken 7 times"> + </span>]:<span class="lineCov">         29 :                 case *packet.EncryptedKey:</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 5 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>][<span class="branchCov" title="Branch 7 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 9 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span>]
<span class="lineNum">     111 </span>                :            :                         // This packet contains the decryption key encrypted to a public key.
<span class="lineNum">     112 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          7 :                         md.EncryptedToKeyIds = append(md.EncryptedToKeyIds, p.KeyId)</span>
<span class="lineNum">     113 </span>[<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          7 :                         switch p.Algo {</span>
<span class="lineNum">     114 </span>                :            :                         case packet.PubKeyAlgoRSA, packet.PubKeyAlgoRSAEncryptOnly, packet.PubKeyAlgoElGamal:
<span class="lineNum">     115 </span>                :<span class="lineCov">          7 :                                 break</span>
<span class="lineNum">     116 </span>                :            :                         default:
<span class="lineNum">     117 </span>                :            :                                 continue
<span class="lineNum">     118 </span>                :            :                         }
<span class="lineNum">     119 </span>                :<span class="lineCov">          7 :                         var keys []Key</span>
<span class="lineNum">     120 </span>[<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchCov" title="Branch 3 was taken 6 times"> + </span>]:<span class="lineCov">          7 :                         if p.KeyId == 0 {</span>
<span class="lineNum">     121 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :                                 keys = keyring.DecryptionKeys()</span>
<span class="lineNum">     122 </span>                :            :                         } else {
<span class="lineNum">     123 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          6 :                                 keys = keyring.KeysById(p.KeyId)</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<span class="lineNum">     124 </span>                :            :                         }
<span class="lineNum">     125 </span>[<span class="branchCov" title="Branch 1 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 8 times"> + </span><span class="branchCov" title="Branch 4 was taken 7 times"> + </span>]:<span class="lineCov">         15 :                         for _, k := range keys {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 8 times"> + </span>]
<span class="lineNum">     126 </span>                :<span class="lineCov">          8 :                                 pubKeys = append(pubKeys, keyEnvelopePair{k, p})</span>
<span class="lineNum">     127 </span>                :            :                         }
<span class="lineNum">     128 </span>[<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 2 times"> + </span><span class="branchCov" title="Branch 4 was taken 9 times"> + </span>]:<span class="lineCov">         18 :                 case *packet.SymmetricallyEncrypted:</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 5 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>][<span class="branchCov" title="Branch 7 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 9 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span>]
<span class="lineNum">     129 </span>                :<span class="lineCov">          9 :                         se = p</span>
<span class="lineNum">     130 </span>                :            :                         break ParsePackets
<span class="lineNum">     131 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          2 :                 case *packet.Compressed, *packet.LiteralData, *packet.OnePassSignature:</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>][<span class="branchNoExec" title="Branch 13 was not executed"> # </span><span class="branchNoExec" title="Branch 14 was not executed"> # </span>]
<span class="lineNum">     132 </span>                :            :                         // This message isn't encrypted.
<span class="lineNum">     133 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                         if len(symKeys) != 0 || len(pubKeys) != 0 {</span>
<span class="lineNum">     134 </span>                :<span class="lineNoCov">          0 :                                 return nil, errors.StructuralError(&quot;key material not followed by encrypted message&quot;)</span>
<span class="lineNum">     135 </span>                :            :                         }
<span class="lineNum">     136 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :                         packets.Unread(p)</span>
<span class="lineNum">     137 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :                         return readSignedMessage(packets, nil, keyring)</span>
<span class="lineNum">     138 </span>                :            :                 }
<span class="lineNum">     139 </span>                :<span class="lineCov">          9 :         }</span>
<span class="lineNum">     140 </span>                :            : 
<span class="lineNum">     141 </span>                :<span class="lineCov">          9 :         var candidates []Key</span>
<span class="lineNum">     142 </span>                :<span class="lineCov">          9 :         var decrypted io.ReadCloser</span>
<span class="lineNum">     143 </span>                :            : 
<span class="lineNum">     144 </span>                :            :         // Now that we have the list of encrypted keys we need to decrypt at
<span class="lineNum">     145 </span>                :            :         // least one of them or, if we cannot, we need to call the prompt
<span class="lineNum">     146 </span>                :            :         // function so that it can decrypt a key or give us a passphrase.
<span class="lineNum">     147 </span>                :            : FindKey:
<span class="lineNum">     148 </span>                :            :         for {
<span class="lineNum">     149 </span>                :            :                 // See if any of the keys already have a private key available
<span class="lineNum">     150 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 11 times"> + </span>]:<span class="lineCov">         11 :                 candidates = candidates[:0]</span>
<span class="lineNum">     151 </span>        [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         11 :                 candidateFingerprints := make(map[string]bool)</span>
<span class="lineNum">     152 </span>                :            : 
<span class="lineNum">     153 </span>[<span class="branchCov" title="Branch 1 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 9 times"> + </span><span class="branchCov" title="Branch 4 was taken 4 times"> + </span>]:<span class="lineCov">         13 :                 for _, pk := range pubKeys {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 9 times"> + </span>]
<span class="lineNum">     154 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">          9 :                         if pk.key.PrivateKey == nil {</span>
<span class="lineNum">     155 </span>                :<span class="lineNoCov">          0 :                                 continue</span>
<span class="lineNum">     156 </span>                :            :                         }
<span class="lineNum">     157 </span>[<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchCov" title="Branch 3 was taken 2 times"> + </span>]:<span class="lineCov">          9 :                         if !pk.key.PrivateKey.Encrypted {</span>
<span class="lineNum">     158 </span>[<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          7 :                                 if len(pk.encryptedKey.Key) == 0 {</span>
<span class="lineNum">     159 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          7 :                                         pk.encryptedKey.Decrypt(pk.key.PrivateKey, config)</span>
<span class="lineNum">     160 </span>                :            :                                 }
<span class="lineNum">     161 </span>[<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 7 times"> + </span>]:<span class="lineCov">          7 :                                 if len(pk.encryptedKey.Key) == 0 {</span>
<span class="lineNum">     162 </span>                :<span class="lineNoCov">          0 :                                         continue</span>
<span class="lineNum">     163 </span>                :            :                                 }
<span class="lineNum">     164 </span>[<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          7 :                                 decrypted, err = se.Decrypt(pk.encryptedKey.CipherFunc, pk.encryptedKey.Key)</span>
<span class="lineNum">     165 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          7 :                                 if err != nil &amp;&amp; err != errors.ErrKeyIncorrect {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 7 times"> + </span>]
<span class="lineNum">     166 </span>                :<span class="lineNoCov">          0 :                                         return nil, err</span>
<span class="lineNum">     167 </span>                :            :                                 }
<span class="lineNum">     168 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          7 :                                 if decrypted != nil {</span>
<span class="lineNum">     169 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          7 :                                         md.DecryptedWith = pk.key</span>
<span class="lineNum">     170 </span>                :            :                                         break FindKey
<span class="lineNum">     171 </span>                :            :                                 }
<span class="lineNum">     172 </span>                :            :                         } else {
<span class="lineNum">     173 </span>                :<span class="lineCov">          2 :                                 fpr := string(pk.key.PublicKey.Fingerprint[:])</span>
<span class="lineNum">     174 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                                 if v := candidateFingerprints[fpr]; v {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchCov" title="Branch 7 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">     175 </span>                :            :                                         continue
<span class="lineNum">     176 </span>                :            :                                 }
<span class="lineNum">     177 </span>                :<span class="lineCov">          2 :                                 candidates = append(candidates, pk.key)</span>
<span class="lineNum">     178 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          2 :                                 candidateFingerprints[fpr] = true</span>
<span class="lineNum">     179 </span>                :            :                         }
<span class="lineNum">     180 </span>                :            :                 }
<span class="lineNum">     181 </span>                :            : 
<span class="lineNum">     182 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 4 times"> + </span>]:<span class="lineCov">         11 :                 if len(candidates) == 0 &amp;&amp; len(symKeys) == 0 {</span>
<span class="lineNum">     183 </span>                :<span class="lineNoCov">          0 :                         return nil, errors.ErrKeyIncorrect</span>
<span class="lineNum">     184 </span>                :            :                 }
<span class="lineNum">     185 </span>                :            : 
<span class="lineNum">     186 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">          4 :                 if prompt == nil {</span>
<span class="lineNum">     187 </span>                :<span class="lineNoCov">          0 :                         return nil, errors.ErrKeyIncorrect</span>
<span class="lineNum">     188 </span>                :            :                 }
<span class="lineNum">     189 </span>                :            : 
<span class="lineNum">     190 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          4 :                 passphrase, err := prompt(candidates, len(symKeys) != 0)</span>
<span class="lineNum">     191 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">          4 :                 if err != nil {</span>
<span class="lineNum">     192 </span>                :<span class="lineNoCov">          0 :                         return nil, err</span>
<span class="lineNum">     193 </span>                :            :                 }
<span class="lineNum">     194 </span>                :            : 
<span class="lineNum">     195 </span>                :            :                 // Try the symmetric passphrase first
<span class="lineNum">     196 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchCov" title="Branch 3 was taken 2 times"> + </span>]:<span class="lineCov">          4 :                 if len(symKeys) != 0 &amp;&amp; passphrase != nil {</span>
<span class="lineNum">     197 </span>[<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          2 :                         for _, s := range symKeys {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 2 times"> + </span>]
<span class="lineNum">     198 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                                 err = s.Decrypt(passphrase)</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchCov" title="Branch 7 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">     199 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          2 :                                 if err == nil &amp;&amp; !s.Encrypted {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<span class="lineNum">     200 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          2 :                                         decrypted, err = se.Decrypt(s.CipherFunc, s.Key)</span>
<span class="lineNum">     201 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          2 :                                         if err != nil &amp;&amp; err != errors.ErrKeyIncorrect {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 2 times"> + </span>]
<span class="lineNum">     202 </span>                :<span class="lineNoCov">          0 :                                                 return nil, err</span>
<span class="lineNum">     203 </span>                :            :                                         }
<span class="lineNum">     204 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                                         if decrypted != nil {</span>
<span class="lineNum">     205 </span>                :            :                                                 break FindKey
<span class="lineNum">     206 </span>                :            :                                         }
<span class="lineNum">     207 </span>                :            :                                 }
<span class="lineNum">     208 </span>                :            : 
<span class="lineNum">     209 </span>                :            :                         }
<span class="lineNum">     210 </span>                :            :                 }
<span class="lineNum">     211 </span>                :<span class="lineCov">          2 :         }</span>
<span class="lineNum">     212 </span>                :            : 
<span class="lineNum">     213 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :         md.decrypted = decrypted</span>
<span class="lineNum">     214 </span>[<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          9 :         packets.Push(decrypted)</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchCov" title="Branch 7 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">     215 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         11 :         return readSignedMessage(packets, md, keyring)</span>
<span class="lineNum">     216 </span>                :            : }
<span class="lineNum">     217 </span>                :            : 
<span class="lineNum">     218 </span>                :            : // readSignedMessage reads a possibly signed message if mdin is non-zero then
<a name="219"><span class="lineNum">     219 </span>                :            : // that structure is updated and returned. Otherwise a fresh MessageDetails is</a>
<span class="lineNum">     220 </span>                :            : // used.
<span class="lineNum">     221 </span>                :<span class="lineCov">         11 : func readSignedMessage(packets *packet.Reader, mdin *MessageDetails, keyring KeyRing) (md *MessageDetails, err error) {</span>
<span class="lineNum">     222 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">         11 :         if mdin == nil {</span>
<span class="lineNum">     223 </span>                :<span class="lineCov">          2 :                 mdin = new(MessageDetails)</span>
<span class="lineNum">     224 </span>                :            :         }
<span class="lineNum">     225 </span>                :<span class="lineCov">         11 :         md = mdin</span>
<span class="lineNum">     226 </span>                :            : 
<span class="lineNum">     227 </span>                :<span class="lineCov">         11 :         var p packet.Packet</span>
<span class="lineNum">     228 </span>                :<span class="lineCov">         11 :         var h hash.Hash</span>
<span class="lineNum">     229 </span>                :<span class="lineCov">         11 :         var wrappedHash hash.Hash</span>
<span class="lineNum">     230 </span>                :            : FindLiteralData:
<span class="lineNum">     231 </span>                :            :         for {
<span class="lineNum">     232 </span>        [<span class="branchCov" title="Branch 0 was taken 22 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         22 :                 p, err = packets.Next()</span>
<span class="lineNum">     233 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 22 times"> + </span>]:<span class="lineCov">         22 :                 if err != nil {</span>
<span class="lineNum">     234 </span>                :<span class="lineNoCov">          0 :                         return nil, err</span>
<span class="lineNum">     235 </span>                :            :                 }
<span class="lineNum">     236 </span>        [<span class="branchCov" title="Branch 0 was taken 22 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         22 :                 switch p := p.(type) {</span>
<span class="lineNum">     237 </span>[<span class="branchCov" title="Branch 0 was taken 22 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 17 times"> + </span><span class="branchCov" title="Branch 4 was taken 5 times"> + </span>]:<span class="lineCov">         22 :                 case *packet.Compressed:</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 5 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>][<span class="branchCov" title="Branch 7 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 9 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span>]
<span class="lineNum">     238 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          5 :                         packets.Push(p.Body)</span>
<span class="lineNum">     239 </span>[<span class="branchCov" title="Branch 0 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 11 times"> + </span><span class="branchCov" title="Branch 4 was taken 6 times"> + </span>]:<span class="lineCov">         22 :                 case *packet.OnePassSignature:</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 5 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>][<span class="branchCov" title="Branch 7 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 9 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span>]
<span class="lineNum">     240 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 6 times"> + </span>]:<span class="lineCov">          6 :                         if !p.IsLast {</span>
<span class="lineNum">     241 </span>                :<span class="lineNoCov">          0 :                                 return nil, errors.UnsupportedError(&quot;nested signatures&quot;)</span>
<span class="lineNum">     242 </span>                :            :                         }
<span class="lineNum">     243 </span>                :            : 
<span class="lineNum">     244 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          6 :                         h, wrappedHash, err = hashForSignature(p.Hash, p.SigType)</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<span class="lineNum">     245 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          6 :                         if err != nil {</span>
<span class="lineNum">     246 </span>                :<span class="lineNoCov">          0 :                                 md = nil</span>
<span class="lineNum">     247 </span>                :<span class="lineNoCov">          0 :                                 return</span>
<span class="lineNum">     248 </span>                :            :                         }
<span class="lineNum">     249 </span>                :            : 
<span class="lineNum">     250 </span>        [<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          6 :                         md.IsSigned = true</span>
<span class="lineNum">     251 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          6 :                         md.SignedByKeyId = p.KeyId</span>
<span class="lineNum">     252 </span>[<span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          6 :                         keys := keyring.KeysById(p.KeyId)</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 5 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]
<span class="lineNum">     253 </span>[<span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          6 :                         for i, key := range keys {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 6 times"> + </span>]
<span class="lineNum">     254 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          6 :                                 if key.SelfSignature.FlagsValid &amp;&amp; !key.SelfSignature.FlagSign {</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 6 times"> + </span>]
<span class="lineNum">     255 </span>                :<span class="lineNoCov">          0 :                                         continue</span>
<span class="lineNum">     256 </span>                :            :                                 }
<span class="lineNum">     257 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          6 :                                 md.SignedBy = &amp;keys[i]</span>
<span class="lineNum">     258 </span>                :<span class="lineCov">          6 :                                 break</span>
<span class="lineNum">     259 </span>                :            :                         }
<span class="lineNum">     260 </span>[<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 11 times"> + </span>]:<span class="lineCov">         17 :                 case *packet.LiteralData:</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 5 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>][<span class="branchCov" title="Branch 7 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 9 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span>]
<span class="lineNum">     261 </span>        [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         11 :                         md.LiteralData = p</span>
<span class="lineNum">     262 </span>                :            :                         break FindLiteralData
<span class="lineNum">     263 </span>                :            :                 }
<span class="lineNum">     264 </span>                :<span class="lineCov">         11 :         }</span>
<span class="lineNum">     265 </span>                :            : 
<span class="lineNum">     266 </span>[<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 6 times"> + </span><span class="branchCov" title="Branch 3 was taken 5 times"> + </span>]:<span class="lineCov">         11 :         if md.SignedBy != nil {</span>
<span class="lineNum">     267 </span>[<span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          6 :                 md.UnverifiedBody = &amp;signatureCheckReader{packets, h, wrappedHash, md}</span>
<span class="lineNum">     268 </span>[<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          5 :         } else if md.decrypted != nil {</span>
<span class="lineNum">     269 </span>[<span class="branchCov" title="Branch 1 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">          5 :                 md.UnverifiedBody = checkReader{md}</span>
<span class="lineNum">     270 </span>                :            :         } else {
<span class="lineNum">     271 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 md.UnverifiedBody = md.LiteralData.Body</span>
<span class="lineNum">     272 </span>                :            :         }
<span class="lineNum">     273 </span>                :            : 
<span class="lineNum">     274 </span>                :<span class="lineCov">         11 :         return md, nil</span>
<span class="lineNum">     275 </span>                :            : }
<span class="lineNum">     276 </span>                :            : 
<span class="lineNum">     277 </span>                :            : // hashForSignature returns a pair of hashes that can be used to verify a
<span class="lineNum">     278 </span>                :            : // signature. The signature may specify that the contents of the signed message
<span class="lineNum">     279 </span>                :            : // should be preprocessed (i.e. to normalize line endings). Thus this function
<a name="280"><span class="lineNum">     280 </span>                :            : // returns two hashes. The second should be used to hash the message itself and</a>
<span class="lineNum">     281 </span>                :            : // performs any needed preprocessing.
<span class="lineNum">     282 </span>                :<span class="lineCov">         21 : func hashForSignature(hashId crypto.Hash, sigType packet.SignatureType) (hash.Hash, hash.Hash, error) {</span>
<span class="lineNum">     283 </span>        [<span class="branchCov" title="Branch 0 was taken 21 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         21 :         h := hashId.New()</span>
<span class="lineNum">     284 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 21 times"> + </span>]:<span class="lineCov">         21 :         if h == nil {</span>
<span class="lineNum">     285 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 return nil, nil, errors.UnsupportedError(&quot;hash not available: &quot; + strconv.Itoa(int(hashId)))</span>
<span class="lineNum">     286 </span>                :            :         }
<span class="lineNum">     287 </span>                :            : 
<span class="lineNum">     288 </span>     [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         21 :         switch sigType {</span>
<span class="lineNum">     289 </span>                :            :         case packet.SigTypeBinary:
<span class="lineNum">     290 </span>                :<span class="lineCov">         11 :                 return h, h, nil</span>
<span class="lineNum">     291 </span>                :            :         case packet.SigTypeText:
<span class="lineNum">     292 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         10 :                 return h, NewCanonicalTextHash(h), nil</span>
<span class="lineNum">     293 </span>                :            :         }
<span class="lineNum">     294 </span>                :            : 
<span class="lineNum">     295 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineCov">         21 :         return nil, nil, errors.UnsupportedError(&quot;unsupported signature type: &quot; + strconv.Itoa(int(sigType)))</span>
<span class="lineNum">     296 </span>                :            : }
<span class="lineNum">     297 </span>                :            : 
<span class="lineNum">     298 </span>                :            : // checkReader wraps an io.Reader from a LiteralData packet. When it sees EOF
<span class="lineNum">     299 </span>                :            : // it closes the ReadCloser from any SymmetricallyEncrypted packet to trigger
<span class="lineNum">     300 </span>                :            : // MDC checks.
<span class="lineNum">     301 </span>                :            : type checkReader struct {
<span class="lineNum">     302 </span>                :            :         md *MessageDetails
<a name="303"><span class="lineNum">     303 </span>                :            : }</a>
<span class="lineNum">     304 </span>                :            : 
<span class="lineNum">     305 </span>        [<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         15 : func (cr checkReader) Read(buf []byte) (n int, err error) {</span>
<span class="lineNum">     306 </span>[<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         15 :         n, err = cr.md.LiteralData.Body.Read(buf)</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchCov" title="Branch 6 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">     307 </span>[<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 5 times"> + </span><span class="branchCov" title="Branch 4 was taken 10 times"> + </span>]:<span class="lineCov">         15 :         if err == io.EOF {</span>
<span class="lineNum">     308 </span>[<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          5 :                 mdcErr := cr.md.decrypted.Close()</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<span class="lineNum">     309 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          5 :                 if mdcErr != nil {</span>
<span class="lineNum">     310 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          5 :                         err = mdcErr</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">     311 </span>                :            :                 }
<span class="lineNum">     312 </span>                :            :         }
<span class="lineNum">     313 </span>                :<span class="lineCov">         15 :         return</span>
<span class="lineNum">     314 </span>                :            : }
<span class="lineNum">     315 </span>                :            : 
<span class="lineNum">     316 </span>                :            : // signatureCheckReader wraps an io.Reader from a LiteralData packet and hashes
<span class="lineNum">     317 </span>                :            : // the data as it is read. When it sees an EOF from the underlying io.Reader
<span class="lineNum">     318 </span>                :            : // it parses and checks a trailing Signature packet and triggers any MDC checks.
<span class="lineNum">     319 </span>                :            : type signatureCheckReader struct {
<span class="lineNum">     320 </span>                :            :         packets        *packet.Reader
<span class="lineNum">     321 </span>                :            :         h, wrappedHash hash.Hash
<span class="lineNum">     322 </span>                :            :         md             *MessageDetails
<a name="323"><span class="lineNum">     323 </span>                :            : }</a>
<span class="lineNum">     324 </span>                :            : 
<span class="lineNum">     325 </span>                :<span class="lineCov">         17 : func (scr *signatureCheckReader) Read(buf []byte) (n int, err error) {</span>
<span class="lineNum">     326 </span>[<span class="branchCov" title="Branch 0 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         17 :         n, err = scr.md.LiteralData.Body.Read(buf)</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchCov" title="Branch 6 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 8 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>]
<span class="lineNum">     327 </span>[<span class="branchCov" title="Branch 0 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         17 :         scr.wrappedHash.Write(buf[:n])</span>
<span class="lineNum">         </span>[<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 17 times"> + </span>][<span class="branchCov" title="Branch 7 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">     328 </span>[<span class="branchCov" title="Branch 0 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 6 times"> + </span><span class="branchCov" title="Branch 4 was taken 11 times"> + </span>]:<span class="lineCov">         17 :         if err == io.EOF {</span>
<span class="lineNum">     329 </span>                :<span class="lineCov">          6 :                 var p packet.Packet</span>
<span class="lineNum">     330 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          6 :                 p, scr.md.SignatureError = scr.packets.Next()</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchCov" title="Branch 7 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">     331 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          6 :                 if scr.md.SignatureError != nil {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 6 times"> + </span>]
<span class="lineNum">     332 </span>                :<span class="lineNoCov">          0 :                         return</span>
<span class="lineNum">     333 </span>                :            :                 }
<span class="lineNum">     334 </span>                :            : 
<span class="lineNum">     335 </span>                :<span class="lineCov">          6 :                 var ok bool</span>
<span class="lineNum">     336 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          6 :                 if scr.md.Signature, ok = p.(*packet.Signature); !ok {</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 5 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>][<span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchCov" title="Branch 8 was taken 6 times"> + </span>]
<span class="lineNum">     337 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         scr.md.SignatureError = errors.StructuralError(&quot;LiteralData not followed by Signature&quot;)</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">     338 </span>                :<span class="lineNoCov">          0 :                         return</span>
<span class="lineNum">     339 </span>                :            :                 }
<span class="lineNum">     340 </span>                :            : 
<span class="lineNum">     341 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          6 :                 scr.md.SignatureError = scr.md.SignedBy.PublicKey.VerifySignature(scr.h, scr.md.Signature)</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchCov" title="Branch 6 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 8 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>][<span class="branchCov" title="Branch 10 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 12 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 13 was not taken"> - </span>][<span class="branchNoCov" title="Branch 15 was not taken"> - </span><span class="branchCov" title="Branch 16 was taken 6 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 17 was not executed"> # </span><span class="branchNoExec" title="Branch 18 was not executed"> # </span>][<span class="branchCov" title="Branch 19 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 20 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 22 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 23 was not taken"> - </span>][<span class="branchCov" title="Branch 24 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 25 was not taken"> - </span>]
<span class="lineNum">     342 </span>                :            : 
<span class="lineNum">     343 </span>                :            :                 // The SymmetricallyEncrypted packet, if any, might have an
<span class="lineNum">     344 </span>                :            :                 // unsigned hash of its own. In order to check this we need to
<span class="lineNum">     345 </span>                :            :                 // close that Reader.
<span class="lineNum">     346 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          6 :                 if scr.md.decrypted != nil {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 4 times"> + </span><span class="branchCov" title="Branch 5 was taken 2 times"> + </span>]
<span class="lineNum">     347 </span>[<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          4 :                         mdcErr := scr.md.decrypted.Close()</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchCov" title="Branch 6 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">     348 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">          4 :                         if mdcErr != nil {</span>
<span class="lineNum">     349 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          6 :                                 err = mdcErr</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">     350 </span>                :            :                         }
<span class="lineNum">     351 </span>                :            :                 }
<span class="lineNum">     352 </span>                :            :         }
<span class="lineNum">     353 </span>                :<span class="lineCov">         17 :         return</span>
<span class="lineNum">     354 </span>                :            : }
<span class="lineNum">     355 </span>                :            : 
<span class="lineNum">     356 </span>                :            : // CheckDetachedSignature takes a signed file and a detached signature and
<a name="357"><span class="lineNum">     357 </span>                :            : // returns the signer if the signature is valid. If the signer isn't known,</a>
<span class="lineNum">     358 </span>                :            : // ErrUnknownIssuer is returned.
<span class="lineNum">     359 </span>                :<span class="lineCov">         12 : func CheckDetachedSignature(keyring KeyRing, signed, signature io.Reader) (signer *Entity, err error) {</span>
<span class="lineNum">     360 </span>[<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 12 times"> + </span>]:<span class="lineCov">         12 :         p, err := packet.Read(signature)</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchCov" title="Branch 7 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">     361 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">         12 :         if err != nil {</span>
<span class="lineNum">     362 </span>                :<span class="lineNoCov">          0 :                 return</span>
<span class="lineNum">     363 </span>                :            :         }
<span class="lineNum">     364 </span>                :            : 
<span class="lineNum">     365 </span>        [<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         12 :         sig, ok := p.(*packet.Signature)</span>
<span class="lineNum">     366 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">         12 :         if !ok {</span>
<span class="lineNum">     367 </span>                :<span class="lineNoCov">          0 :                 return nil, errors.StructuralError(&quot;non signature packet found&quot;)</span>
<span class="lineNum">     368 </span>                :            :         }
<span class="lineNum">     369 </span>                :            : 
<span class="lineNum">     370 </span>[<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 12 times"> + </span>]:<span class="lineCov">         12 :         if sig.IssuerKeyId == nil {</span>
<span class="lineNum">     371 </span>                :<span class="lineNoCov">          0 :                 return nil, errors.StructuralError(&quot;signature doesn't have an issuer&quot;)</span>
<span class="lineNum">     372 </span>                :            :         }
<span class="lineNum">     373 </span>                :            : 
<span class="lineNum">     374 </span>[<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         12 :         keys := keyring.KeysById(*sig.IssuerKeyId)</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchCov" title="Branch 6 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">     375 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">         12 :         if len(keys) == 0 {</span>
<span class="lineNum">     376 </span>                :<span class="lineNoCov">          0 :                 return nil, errors.ErrUnknownIssuer</span>
<span class="lineNum">     377 </span>                :            :         }
<span class="lineNum">     378 </span>                :            : 
<span class="lineNum">     379 </span>[<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         12 :         h, wrappedHash, err := hashForSignature(sig.Hash, sig.SigType)</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchCov" title="Branch 8 was taken 12 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 9 was not executed"> # </span><span class="branchNoExec" title="Branch 10 was not executed"> # </span>][<span class="branchCov" title="Branch 11 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span>]
<span class="lineNum">     380 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">         12 :         if err != nil {</span>
<span class="lineNum">     381 </span>                :<span class="lineNoCov">          0 :                 return</span>
<span class="lineNum">     382 </span>                :            :         }
<span class="lineNum">     383 </span>                :            : 
<span class="lineNum">     384 </span>[<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         12 :         _, err = io.Copy(wrappedHash, signed)</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchCov" title="Branch 7 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">     385 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">         12 :         if err != nil &amp;&amp; err != io.EOF {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 12 times"> + </span>]
<span class="lineNum">     386 </span>                :<span class="lineNoCov">          0 :                 return</span>
<span class="lineNum">     387 </span>                :            :         }
<span class="lineNum">     388 </span>                :            : 
<span class="lineNum">     389 </span>[<span class="branchCov" title="Branch 1 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         12 :         for _, key := range keys {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 12 times"> + </span>]
<span class="lineNum">     390 </span>[<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         12 :                 if key.SelfSignature.FlagsValid &amp;&amp; !key.SelfSignature.FlagSign {</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 12 times"> + </span>]
<span class="lineNum">     391 </span>                :<span class="lineNoCov">          0 :                         continue</span>
<span class="lineNum">     392 </span>                :            :                 }
<span class="lineNum">     393 </span>[<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 12 times"> + </span>]:<span class="lineCov">         12 :                 err = key.PublicKey.VerifySignature(h, sig)</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchCov" title="Branch 7 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span>]
<span class="lineNum">     394 </span>        [<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         12 :                 if err == nil {</span>
<span class="lineNum">     395 </span>                :<span class="lineCov">         12 :                         return key.Entity, nil</span>
<span class="lineNum">     396 </span>                :            :                 }
<span class="lineNum">     397 </span>                :            :         }
<span class="lineNum">     398 </span>                :            : 
<span class="lineNum">     399 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if err != nil {</span>
<span class="lineNum">     400 </span>                :<span class="lineNoCov">          0 :                 return</span>
<span class="lineNum">     401 </span>                :            :         }
<span class="lineNum">     402 </span>                :            : 
<span class="lineNum">     403 </span>                :<span class="lineCov">         12 :         return nil, errors.ErrUnknownIssuer</span>
<span class="lineNum">     404 </span>                :            : }
<span class="lineNum">     405 </span>                :            : 
<a name="406"><span class="lineNum">     406 </span>                :            : // CheckArmoredDetachedSignature performs the same actions as</a>
<span class="lineNum">     407 </span>                :            : // CheckDetachedSignature but expects the signature to be armored.
<span class="lineNum">     408 </span>                :<span class="lineNoCov">          0 : func CheckArmoredDetachedSignature(keyring KeyRing, signed, signature io.Reader) (signer *Entity, err error) {</span>
<span class="lineNum">     409 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         body, err := readArmored(signature, SignatureType)</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">     410 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if err != nil {</span>
<span class="lineNum">     411 </span>                :<span class="lineNoCov">          0 :                 return</span>
<span class="lineNum">     412 </span>                :            :         }
<span class="lineNum">     413 </span>                :            : 
<span class="lineNum">     414 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         return CheckDetachedSignature(keyring, signed, body)</span>
<span class="lineNum">     415 </span>                :            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.9</a></td></tr>
  </table>
  <br>

</body>
</html>
